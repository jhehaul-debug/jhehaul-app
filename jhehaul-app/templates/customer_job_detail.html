{% extends "base.html" %}
{% block title %}Job #{{ job.id }} - JHE Haul{% endblock %}
{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start;">
        <h2>Job #{{ job.id }}</h2>
        <span class="status status-{{ job.status }}">{{ job.status.replace('_', ' ').title() }}</span>
    </div>
    <hr>
    <p><strong>Description:</strong><br>{{ job.job_description }}</p>
    <p><strong>Address:</strong> {{ job.pickup_address }}</p>
    
    {% if job.photos %}
    <h4>Photos</h4>
    <div class="photo-grid">
        {% for photo in job.photos %}
        <img src="/uploads/{{ photo.filename }}" alt="Job photo">
        {% endfor %}
    </div>
    {% endif %}

    {% if job.status in ['open', 'bidding', 'accepted', 'deposit_paid'] %}
    <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4>Add More Photos</h4>
        <form method="POST" action="{{ url_for('customer_upload_photos', job_id=job.id) }}" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" name="photos" multiple accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary">Upload Photos</button>
        </form>
    </div>
    {% endif %}
</div>

{% if job.status == 'accepted' and not job.deposit_paid and (pay_link or checkout_over500_url) %}
<div class="card" style="background: #fff3cd; border: 2px solid #ffc107;">
    <h3>Payment Required</h3>
    <p>You accepted a bid. Pay the deposit to unlock your address for the hauler.</p>
    {% if checkout_over500_url %}
    <a href="{{ checkout_over500_url }}" class="btn btn-success" style="margin-top: 15px;">Pay Deposit (Stripe)</a>
    {% else %}
    <a href="{{ pay_link }}" target="_blank" class="btn btn-success" style="margin-top: 15px;">Pay Deposit (Stripe)</a>
    {% endif %}
</div>
{% endif %}

{% if job.status == 'deposit_paid' %}
<div class="card" style="background: #d4edda; border: 2px solid #28a745;">
    <h3>Deposit Paid</h3>
    <p>The hauler can now see your address and will contact you soon.</p>
    {% set accepted_bid = bids|selectattr('status', 'equalto', 'accepted')|first %}
    {% if accepted_bid and accepted_bid.hauler_phone %}
    <p style="margin-top: 10px;"><strong>Hauler:</strong> {{ accepted_bid.hauler_name }}</p>
    <p><strong>Phone:</strong> {{ accepted_bid.hauler_phone_formatted }}</p>
    {% endif %}
    <form method="POST" action="{{ url_for('customer_complete_job', job_id=job.id) }}" style="margin-top: 15px;">
        <button type="submit" class="btn btn-success">Mark Job as Complete</button>
    </form>
</div>
{% endif %}

{% if job.status == 'completed' %}
<div class="card" style="background: #e8f5e9; border: 2px solid #28a745;">
    <h3>Job Completed!</h3>
    <p>Completed on {{ job.completed_at.strftime('%B %d, %Y') if job.completed_at else 'N/A' }}</p>
    {% set review = job.reviews|first if job.reviews else None %}
    {% if review %}
    <p style="margin-top: 10px;"><strong>Your Review:</strong> {{ review.rating }} stars</p>
    {% if review.comment %}<p>{{ review.comment }}</p>{% endif %}
    {% else %}
    <a href="{{ url_for('customer_review', job_id=job.id) }}" class="btn btn-primary" style="margin-top: 10px;">Leave a Review</a>
    {% endif %}
</div>
{% endif %}

{% if job.status in ['open', 'bidding'] %}
<div class="card">
    <form method="POST" action="{{ url_for('customer_cancel_job', job_id=job.id) }}" onsubmit="return confirm('Are you sure you want to cancel this job?');">
        <button type="submit" class="btn btn-danger">Cancel This Job</button>
    </form>
</div>
{% endif %}

<div class="card">
    <h3>Bids ({{ bids|length }})</h3>
    <hr>
    {% if not bids %}
    <p>No bids yet. Haulers will see your job and submit quotes.</p>
    {% else %}
    {% for bid in bids %}
    <div style="border: 1px solid #eee; padding: 15px; margin-bottom: 15px; border-radius: 8px; {% if bid.status == 'accepted' %}background: #e8f5e9;{% endif %}">
        <div style="display: flex; justify-content: space-between;">
            <div>
                <strong>{{ bid.hauler_name }}</strong>
                {% if job.deposit_paid and bid.status == 'accepted' and bid.hauler_phone %}
                <br><small style="color: #27ae60;">Phone: {{ bid.hauler_phone_formatted }}</small>
                {% endif %}
            </div>
            <div style="text-align: right;">
                <strong style="font-size: 1.3rem;">${{ "%.2f"|format(bid.quote_amount) }}</strong>
                {% if bid.status == 'accepted' %}<br><span style="color: green;">Accepted</span>{% endif %}
            </div>
        </div>
        {% if bid.message %}
        <p style="margin-top: 10px; color: #666;">{{ bid.message }}</p>
        {% endif %}
        {% if job.status in ['open', 'bidding'] %}
        <form method="POST" action="{{ url_for('customer_accept_bid', bid_id=bid.id) }}" style="margin-top: 10px;">
            <button type="submit" class="btn btn-success">Accept This Bid</button>
        </form>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}
</div>

<p><a href="{{ url_for('customer_jobs') }}">Back to My Jobs</a></p>
{% endblock %}
